{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-0">
    <div id="map" style="height: 65vh;"></div>
</div>

<div class="container mt-3">
    <h4 class="text-kenya-green mb-2">Projects Across Kenya</h4>
    <p class="text-muted fs-6 mb-3">Click on any marker to see project details</p>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card border-kenya-green">
                <div class="card-header bg-kenya-green text-white py-2">
                    <h6 class="mb-0">Project Legend</h6>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex flex-wrap gap-3 fs-6">
                        <span><i class="fas fa-map-marker-alt text-primary me-1"></i> Ongoing Projects</span>
                        <span><i class="fas fa-map-marker-alt text-success me-1"></i> Completed Projects</span>
                        <span><i class="fas fa-map-marker-alt text-warning me-1"></i> Delayed Projects</span>
                        <span><i class="fas fa-map-marker-alt text-secondary me-1"></i> Planned Projects</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    var map = L.map('map').setView([-1.286, 36.817], 7);
    
    // Add base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add project markers
    var geojson = {{ geojson|safe }};
    
    L.geoJSON(geojson, {
        pointToLayer: function(feature, latlng) {
            // Choose marker color based on status
            var color;
            switch(feature.properties.status) {
                case 'ongoing': color = 'blue'; break;
                case 'completed': color = 'green'; break;
                case 'delayed': color = 'orange'; break;
                default: color = 'gray';
            }
            
            // Create marker
            var marker = L.marker(latlng, {
                icon: L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [20, 32],
                    iconAnchor: [10, 32],
                    popupAnchor: [1, -28],
                    shadowSize: [32, 32]
                })
            });
            
            // Bind popup
            marker.bindPopup(`
                <div class="p-1">
                    <h6 class="text-kenya-green mb-1">${feature.properties.name}</h6>
                    <p class="mb-1 fs-6">Status: ${feature.properties.status}</p>
                    <p class="mb-2 fs-6">County: ${feature.properties.county}</p>
                    <a href="/projects/${feature.properties.id}/" class="btn btn-kenya-green btn-sm">View Details</a>
                </div>
            `);
            
            return marker;
        }
    }).addTo(map);
</script>
{% endblock %}